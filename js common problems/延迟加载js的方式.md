<!--
 * @Description:
 * @Author: 曹俊
 * @Date: 2022-08-16 11:44:30
 * @LastEditors: 曹俊
 * @LastEditTime: 2022-11-05 18:53:09
-->

# 问题引入：

浏览器的解析规则是：如果遇到 script 标签，则暂停构建 DOM，转而开始执行 script 标签，如果是外部 script，那么浏览器还需要一直等待其「下载」并「执行」后，再继续解析后面的 HTML。

# 延迟加载 js 的方式：script 标签的两个属性

- defer：
  - 不阻塞浏览器解析 HTML，等解析完 HTML 之后，才会执行 `script`。
  - 会并行下载 JavaScript 资源。
  - 会按照 HTML 中的相对顺序执行脚本。
  - 会在脚本下载并执行完成之后，才会触发 `DOMContentLoaded` 事件。
  - 在脚本执行过程中，一定可以获取到 HTML 中已有的元素。
  - `defer` 属性对模块脚本无效。
  - 适用于：所有外部脚本（通过 src 引用的 `script`）。
- async：
  - 不阻塞浏览器解析 HTML，但是 `script` 下载完成后，会立即中断浏览器解析 HTML，并执行此 `script`。
  - 会并行下载 JavaScript 资源。
  - 互相独立，谁先下载完，谁先执行，没有固定的先后顺序，不可控。
  - 由于没有确定的执行时机，所以在脚本里面可能会获取不到 HTML 中已有的元素。
  - `DOMContentLoaded` 事件和 `script` 脚本无相关性，无法确定他们的先后顺序。
  - 适用于：独立的第三方脚本。

### 总结：async 和 defer 之间最大的

- 区别：在于它们的执行时机
- 共同点：都可以并行下载 JavaScript 资源

## One More Thing

### 你有没有想过，如果一个 script 标签同时设置 defer 和 async，浏览器会如何处理？

#### 先说结论：从表现形式上来说，async 的优先级比 defer 高，也就是如果同时存在这 2 个属性，那么浏览器将会以 async 的特性去加载此脚本。

### 这主要分 2 种情况：

- 如果是「普通脚本」，浏览器会优先判断 async 属性是否存在，如果存在，则以 async 特性去加载此脚本，如果不存在，再去判断是否存在 defer 属性。

- 如果是「模块脚本」，浏览器会判断 async 属性是否存在：
  - 如果存在，浏览器会并行下载此模块和他的所有依赖模块，等全部下载完成之后，会立刻执行此脚本。
  - 如果不存在，浏览器也会并行下载此模块和他的所有依赖模块，然后等浏览器解析完 HTML 之后再执行此脚本。
  - 另外需要注意的是：在模块脚本上设置 defer 属性是无效的。
